import type { Express } from "express";
import express from "express";
import { createServer, type Server } from "http";
import multer from "multer";
import path from "path";
import fs from "fs";
import { firebaseService } from "./firebaseService";
import { simpleStorage } from "./simpleStorage";
import { 
  insertUserSchema, 
  insertCategorySchema, 
  insertProductSchema, 
  insertCustomerSchema, 
  insertOrderSchema,
  insertOrderItemSchema,
  type User
} from "@shared/schema";
import { z } from "zod";

const loginSchema = z.object({
  phoneOrEmail: z.string().min(1),
  password: z.string().min(1),
});

export async function registerRoutes(app: Express): Promise<Server> {
  // ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„Ù…Ù„ÙØ§Øª Ø§Ù„Ø«Ø§Ø¨ØªØ© Ù…Ù† Ù…Ø¬Ù„Ø¯ uploads
  const uploadsDir = path.join(process.cwd(), 'uploads');
  if (!fs.existsSync(uploadsDir)) {
    fs.mkdirSync(uploadsDir, { recursive: true });
  }
  app.use('/uploads', express.static(uploadsDir));

  // Ø¥Ø¹Ø¯Ø§Ø¯ multer Ù„Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
  const storage_multer = multer.diskStorage({
    destination: (req, file, cb) => {
      cb(null, uploadsDir);
    },
    filename: (req, file, cb) => {
      const uniqueSuffix = Date.now() + '-' + Math.round(Math.random() * 1E9);
      cb(null, file.fieldname + '-' + uniqueSuffix + path.extname(file.originalname));
    }
  });

  const upload = multer({ 
    storage: storage_multer,
    limits: {
      fileSize: 5 * 1024 * 1024 // 5MB
    },
    fileFilter: (req, file, cb) => {
      const allowedTypes = /jpeg|jpg|png|gif/;
      const extname = allowedTypes.test(path.extname(file.originalname).toLowerCase());
      const mimetype = allowedTypes.test(file.mimetype);
      
      if (mimetype && extname) {
        return cb(null, true);
      } else {
        cb(new Error('ÙŠÙØ³Ù…Ø­ ÙÙ‚Ø· Ø¨Ù…Ù„ÙØ§Øª Ø§Ù„ØµÙˆØ± (jpeg, jpg, png, gif)'));
      }
    }
  });

  // ØªÙ‚Ø¯ÙŠÙ… Ø§Ù„ØµÙˆØ± Ø§Ù„Ù…Ø±ÙÙˆØ¹Ø©
  app.use('/uploads', express.static(uploadsDir));
  
  // Add logging for all requests
  app.use('/api/auth/*', (req, res, next) => {
    console.log(`Ø·Ù„Ø¨ ${req.method} Ø¥Ù„Ù‰ ${req.path}`);
    console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª:', req.body);
    next();
  });
  
  // Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±
  app.post('/api/upload', upload.single('image'), (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({ message: 'Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ Ù…Ù„Ù' });
      }
      
      const imageUrl = `/uploads/${req.file.filename}`;
      res.json({ 
        message: 'ØªÙ… Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø© Ø¨Ù†Ø¬Ø§Ø­',
        url: imageUrl,
        filename: req.file.filename
      });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
      res.status(500).json({ message: 'Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©' });
    }
  });

  // Test route first
  app.post("/api/auth/test", (req, res) => {
    console.log("=== TEST ROUTE WORKING ===");
    res.json({ success: true });
  });

  // Login route with real user data
  app.post("/api/auth/login", async (req, res) => {
    console.log("=== ÙˆØµÙ„ Ø·Ù„Ø¨ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ===");
    console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø³ØªÙ„Ù…Ø©:", req.body);
    
    const { phoneOrEmail, password } = req.body;
    
    if (!phoneOrEmail || !password) {
      console.log("Ø¨ÙŠØ§Ù†Ø§Øª Ù…ÙÙ‚ÙˆØ¯Ø©");
      return res.status(400).json({ message: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ ÙˆÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± Ù…Ø·Ù„ÙˆØ¨Ø§Ù†" });
    }
    
    try {
      // ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù„Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ Ø§Ù„Ù…Ø­Ø¯Ø¯
      if (phoneOrEmail === 'ggkipogo@gmail.com' && password === 'salah5') {
        console.log("ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù…Ø¯ÙŠØ±");
        
        // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª
        try {
          let adminUser = await firebaseService.getUserByPhone('+966500000001');
          if (!adminUser) {
            // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ù…Ø¯ÙŠØ± Ø¥Ø°Ø§ Ù„Ù… ÙŠÙƒÙ† Ù…ÙˆØ¬ÙˆØ¯Ø§Ù‹
            adminUser = await firebaseService.createUser({
              phone: '+966500000001',
              email: 'ggkipogo@gmail.com',
              fullName: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
              role: 'admin',
              password: 'salah5'
            });
            console.log("ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¯ÙŠØ± ÙÙŠ Ù‚Ø§Ø¹Ø¯Ø© Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª");
          }
          
          return res.json({ 
            user: { 
              id: adminUser.id, 
              phone: adminUser.phone,
              email: adminUser.email,
              fullName: adminUser.fullName,
              role: adminUser.role
            } 
          });
        } catch (error) {
          console.log("Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø¯ÙŠØ±:", error);
          // ÙÙŠ Ø­Ø§Ù„Ø© Ø§Ù„Ø®Ø·Ø£ØŒ Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
          return res.json({ 
            user: { 
              id: 1, 
              phone: '+966500000001',
              email: 'ggkipogo@gmail.com',
              fullName: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
              role: 'admin'
            } 
          });
        }
      }

      // Ù…Ø­Ø§ÙˆÙ„Ø© Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Firebase
      let allUsers = [];
      try {
        allUsers = await firebaseService.getUsers();
        console.log("ØªÙ… Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ Firebase Ø¨Ù†Ø¬Ø§Ø­");
      } catch (dbError) {
        console.log("ØªØ¹Ø°Ø± Ø§Ù„ÙˆØµÙˆÙ„ Ø¥Ù„Ù‰ FirebaseØŒ Ø§Ø³ØªØ®Ø¯Ø§Ù… Ø§Ù„Ø­Ø³Ø§Ø¨ Ø§Ù„Ù…Ø¤Ù‚Øª");
        if (phoneOrEmail === 'ggkipogo@gmail.com' && password === 'salah5') {
          return res.json({ 
            user: { 
              id: 1, 
              phone: '+966500000001',
              email: 'ggkipogo@gmail.com',
              fullName: 'Ø§Ù„Ù…Ø¯ÙŠØ± Ø§Ù„Ø¹Ø§Ù…',
              role: 'admin'
            } 
          });
        }
        return res.status(401).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
      }
      
      // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ù‡Ø§ØªÙ Ø£ÙˆÙ„Ø§Ù‹
      console.log("Ø§Ù„Ø¨Ø­Ø« Ø¨Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ:", phoneOrEmail);
      let user = await firebaseService.getUserByPhone(phoneOrEmail);
      
      if (!user) {
        // Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ
        console.log("Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ");
        user = allUsers.find((u: User) => u.email === phoneOrEmail);
        console.log("Ù†ØªÙŠØ¬Ø© Ø§Ù„Ø¨Ø­Ø« Ø¨Ø§Ù„Ø¨Ø±ÙŠØ¯:", user ? "ÙˆÙØ¬Ø¯" : "Ù„Ù… ÙŠÙˆØ¬Ø¯");
      }
      
      if (!user) {
        console.log("Ù„Ù… ÙŠØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…");
        return res.status(401).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
      }
      
      if (user.password !== password) {
        console.log("ÙƒÙ„Ù…Ø© Ø§Ù„Ù…Ø±ÙˆØ± ØºÙŠØ± ØµØ­ÙŠØ­Ø©");
        return res.status(401).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
      }
      
      console.log("ØªØ³Ø¬ÙŠÙ„ Ø¯Ø®ÙˆÙ„ Ù†Ø§Ø¬Ø­ Ù„Ù„Ù…Ø³ØªØ®Ø¯Ù…:", user.phone, "Ø§Ù„Ø¯ÙˆØ±:", user.role);
      
      res.json({ 
        user: { 
          id: user.id, 
          phone: user.phone,
          email: user.email,
          fullName: user.fullName,
          role: user.role 
        } 
      });
    } catch (error: any) {
      console.log("Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø§Ù„Ø¯Ø®ÙˆÙ„:", error.message);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø®Ø§Ø¯Ù…" });
    }
  });

  // Registration route
  app.post("/api/auth/register", async (req, res) => {
    try {
      const userData = insertUserSchema.parse(req.body);
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ
      const existingUserByPhone = await firebaseService.getUserByPhone(userData.phone);
      if (existingUserByPhone) {
        return res.status(400).json({ message: "Ø±Ù‚Ù… Ø§Ù„Ù‡Ø§ØªÙ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„" });
      }
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† Ø¹Ø¯Ù… ÙˆØ¬ÙˆØ¯ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ù†ÙØ³ Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ (Ø¥Ø°Ø§ ØªÙ… Ø¥Ø¯Ø®Ø§Ù„Ù‡)
      if (userData.email) {
        const users = await firebaseService.getUsers();
        const existingUserByEmail = users.find((u: User) => u.email === userData.email);
        if (existingUserByEmail) {
          return res.status(400).json({ message: "Ø§Ù„Ø¨Ø±ÙŠØ¯ Ø§Ù„Ø¥Ù„ÙƒØªØ±ÙˆÙ†ÙŠ Ù…Ø³ØªØ®Ø¯Ù… Ø¨Ø§Ù„ÙØ¹Ù„" });
        }
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù… Ø§Ù„Ø¬Ø¯ÙŠØ¯
      const user = await firebaseService.createUser(userData);
      
      res.status(201).json({ 
        message: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø­Ø³Ø§Ø¨ Ø¨Ù†Ø¬Ø§Ø­",
        user: { 
          id: user.id, 
          phone: user.phone,
          email: user.email,
          fullName: user.fullName,
          role: user.role 
        } 
      });
    } catch (error) {
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  // Users routes
  app.get("/api/users", async (req, res) => {
    try {
      const users = await firebaseService.getUsers();
      res.json(users);
    } catch (error) {
      console.log("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†:", error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ø³ØªØ®Ø¯Ù…ÙŠÙ†" });
    }
  });

  // Categories routes
  app.get("/api/categories", async (req, res) => {
    try {
      const categories = await firebaseService.getCategories();
      res.json(categories);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„ÙØ¦Ø§Øª" });
    }
  });

  app.post("/api/categories", async (req, res) => {
    try {
      const categoryData = insertCategorySchema.parse(req.body);
      const category = await firebaseService.createCategory(categoryData);
      res.status(201).json(category);
    } catch (error) {
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¦Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  app.put("/api/categories/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const categoryData = insertCategorySchema.partial().parse(req.body);
      const category = await firebaseService.updateCategory(id, categoryData);
      
      if (!category) {
        return res.status(404).json({ message: "Ø§Ù„ÙØ¦Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      res.json(category);
    } catch (error) {
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ÙØ¦Ø© ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  app.delete("/api/categories/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const deleted = await firebaseService.deleteCategory(id);
      
      if (!deleted) {
        return res.status(404).json({ message: "Ø§Ù„ÙØ¦Ø© ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯Ø©" });
      }
      
      res.json({ message: "ØªÙ… Ø­Ø°Ù Ø§Ù„ÙØ¦Ø© Ø¨Ù†Ø¬Ø§Ø­" });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„ÙØ¦Ø©" });
    }
  });

  // Products routes
  app.get("/api/products", async (req, res) => {
    try {
      const products = await firebaseService.getProducts();
      res.json(products);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª" });
    }
  });

  app.get("/api/products/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      console.log("Ø·Ù„Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø±Ù‚Ù…:", id);
      
      // Ø¬Ù„Ø¨ Ù…Ù† Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ø¨Ø³ÙŠØ· Ø£ÙˆÙ„Ø§Ù‹
      let product = await simpleStorage.getProduct(id);
      
      // Ø¥Ø°Ø§ Ù„Ù… ÙŠÙˆØ¬Ø¯ØŒ Ø¬Ø±Ø¨ Firebase Ø¨Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø±
      if (!product) {
        try {
          const { doc, getDoc } = await import('firebase/firestore');
          const { db } = await import('./firebaseConfig');
          const productRef = doc(db, 'products', id.toString());
          const docSnap = await getDoc(productRef);
          
          if (docSnap.exists()) {
            const data = docSnap.data();
            console.log(`âœ… ÙˆØ¬Ø¯ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firebase: ${data.name}`);
            
            // Ø¥Ù†Ø´Ø§Ø¡ ÙƒØ§Ø¦Ù† Ù…Ù†ØªØ¬ Ù…Ù† Ø¨ÙŠØ§Ù†Ø§Øª Firebase
            product = {
              id: id,
              name: data.name,
              description: data.description || '',
              price: parseFloat(data.price) || 0,
              stock: data.stock || 0,
              imageUrl: data.imageUrl || '',
              categoryId: data.categoryId || 1,
              createdAt: data.createdAt?.toDate() || new Date(),
              updatedAt: data.updatedAt?.toDate() || new Date()
            };
            
            // Ø­ÙØ¸ ÙÙŠ Ø§Ù„Ù†Ø¸Ø§Ù… Ø§Ù„Ù…Ø­Ù„ÙŠ Ù„Ù„Ù…Ø±Ø§Øª Ø§Ù„Ù‚Ø§Ø¯Ù…Ø©
            await simpleStorage.createProduct(product);
          }
        } catch (firebaseError) {
          console.log('Ø®Ø·Ø£ ÙÙŠ Ø§Ù„Ø¨Ø­Ø« Ø§Ù„Ù…Ø¨Ø§Ø´Ø± ÙÙŠ Firebase:', firebaseError);
        }
      }
      
      if (!product) {
        console.log("Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯:", id);
        return res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      console.log("âœ… ØªÙ… Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­:", product.name);
      
      // Ø¥Ø¶Ø§ÙØ© headers Ù„Ù…Ù†Ø¹ Ø§Ù„Ù€ cache
      res.set({
        'Cache-Control': 'no-cache, no-store, must-revalidate',
        'Pragma': 'no-cache',
        'Expires': '0'
      });
      
      // ØªØ­ÙˆÙŠÙ„ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„ØµÙŠØºØ© Ø§Ù„Ù…Ø·Ù„ÙˆØ¨Ø©
      const responseProduct = {
        id: product.id,
        name: product.name,
        description: product.description,
        price: product.price.toString(),
        stock: product.stock,
        imageUrl: product.imageUrl,
        categoryId: product.categoryId,
        createdAt: product.createdAt,
        updatedAt: product.updatedAt
      };
      
      res.json(responseProduct);
    } catch (error) {
      console.log("Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬:", error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  app.post("/api/products", async (req, res) => {
    try {
      console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø©:", req.body);
      
      // ØªØ­Ø¶ÙŠØ± Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬ Ù…Ø¹ Ø§Ù„Ø­Ù‚ÙˆÙ„ Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©
      const productData: any = {
        name: req.body.name.trim(),
        description: req.body.description ? req.body.description.trim() : null,
        wholesalePrice: req.body.wholesalePrice ? parseFloat(req.body.wholesalePrice) : null,
        minPrice: req.body.minPrice ? parseFloat(req.body.minPrice) : null,
        maxPrice: req.body.maxPrice ? parseFloat(req.body.maxPrice) : null,
        stock: parseInt(req.body.stock),
        categoryId: parseInt(req.body.categoryId),
        imageUrl: req.body.imageUrl || null,
        status: 'active'
      };
      
      console.log("Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù†Ø¸ÙŠÙØ© Ù„Ù„Ø¥Ø¯Ø±Ø§Ø¬:", productData);
      const product = await firebaseService.createProduct(productData);
      res.status(201).json(product);
    } catch (error) {
      console.log("Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬:", error);
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  // Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯
  app.post("/api/products/create", async (req, res) => {
    try {
      const { name, description, price, stock, imageUrl, categoryId, colors, sku, status } = req.body;
      console.log('ğŸ†• Ø¥Ù†Ø´Ø§Ø¡ Ù…Ù†ØªØ¬ Ø¬Ø¯ÙŠØ¯:', name);
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø©
      const firebaseProduct = await firebaseService.createProduct({
        name,
        description,
        price,
        stock,
        imageUrl,
        categoryId: categoryId || 1,
        colors: colors || ['Ø£Ø¨ÙŠØ¶'],
        sku: sku || `SKU-${Date.now()}`,
        status: status || 'active',
        minPrice: Math.round(price * 1.1),
        maxPrice: Math.round(price * 1.5)
      });
      
      console.log(`âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­: ${firebaseProduct.name}`);
      res.json(firebaseProduct);
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // Ø¬Ù„Ø¨ Ù…Ù†ØªØ¬ ÙˆØ§Ø­Ø¯
  app.get("/api/products/:id", async (req, res) => {
    try {
      const productId = parseInt(req.params.id);
      console.log(`Ø·Ù„Ø¨ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬ Ø±Ù‚Ù…: ${productId}`);
      
      const product = await firebaseService.getProduct(productId);
      
      if (!product) {
        console.log(`âŒ Ø§Ù„Ù…Ù†ØªØ¬ ${productId} ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯`);
        return res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      console.log(`âœ… ØªÙ… Ø§Ù„Ø¹Ø«ÙˆØ± Ø¹Ù„Ù‰ Ø§Ù„Ù…Ù†ØªØ¬: ${product.name}`);
      res.json(product);
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ù…Ù†ØªØ¬
  app.put("/api/products/:id", async (req, res) => {
    try {
      const productId = parseInt(req.params.id);
      const { name, description, price, stock, imageUrl } = req.body;
      
      console.log(`ğŸ”„ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ${productId}:`, name);
      
      const updatedProduct = await firebaseService.updateProduct(productId, {
        name,
        description,
        price,
        stock,
        imageUrl,
        minPrice: Math.round(price * 1.1),
        maxPrice: Math.round(price * 1.5)
      });
      
      if (!updatedProduct) {
        return res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      console.log(`âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­: ${updatedProduct.name}`);
      res.json(updatedProduct);
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // Ø­Ø°Ù Ù…Ù†ØªØ¬
  app.delete("/api/products/:id", async (req, res) => {
    try {
      const productId = parseInt(req.params.id);
      
      console.log(`ğŸ—‘ï¸ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ ${productId}`);
      
      const success = await firebaseService.deleteProduct(productId);
      
      if (!success) {
        return res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      console.log(`âœ… ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­`);
      res.json({ message: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­" });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬ ÙÙ‚Ø·
  app.put("/api/products/:id/stock", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      console.log('ğŸ”„ ØªØ­Ø¯ÙŠØ« Ù…Ø®Ø²ÙˆÙ† Ø§Ù„Ù…Ù†ØªØ¬ Ø±Ù‚Ù…:', id);
      
      const updatedProduct = await firebaseService.updateProductStock(id, req.body.stock);
      
      if (!updatedProduct) {
        return res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ† Ø¨Ù†Ø¬Ø§Ø­');
      res.json(updatedProduct);
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ø®Ø²ÙˆÙ†" });
    }
  });



  // Customers routes
  app.get("/api/customers", async (req, res) => {
    try {
      const customers = await firebaseService.getCustomers();
      res.json(customers);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¹Ù…Ù„Ø§Ø¡" });
    }
  });

  app.post("/api/customers", async (req, res) => {
    try {
      const customerData = insertCustomerSchema.parse(req.body);
      const customer = await firebaseService.createCustomer(customerData);
      res.status(201).json(customer);
    } catch (error) {
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø¹Ù…ÙŠÙ„ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  // Product Pages routes
  app.get("/api/product-pages/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      // Ø¥Ø±Ø¬Ø§Ø¹ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§ÙØªØ±Ø§Ø¶ÙŠØ© Ù„Ù„Ù…Ù†ØªØ¬
      const defaultSettings = {
        productId: id,
        settings: {
          showDescription: true,
          showPrice: true,
          showStock: true,
          showCategory: true,
          showImages: true,
          layout: 'default',
          primaryColor: '#8B5CF6',
          backgroundColor: '#FFFFFF',
          customCSS: '',
          seoTitle: '',
          seoDescription: '',
          showReviews: false,
          showRelatedProducts: true,
        },
        customSections: [],
        imageGallery: [],
        updatedAt: new Date().toISOString(),
      };
      res.json(defaultSettings);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©" });
    }
  });

  app.put("/api/product-pages/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      // Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ÙÙŠ Firebase
      console.log("Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª ØµÙØ­Ø© Ø§Ù„Ù…Ù†ØªØ¬:", id, req.body);
      res.json({ message: "ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø¨Ù†Ø¬Ø§Ø­", data: req.body });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¥Ø¹Ø¯Ø§Ø¯Ø§Øª Ø§Ù„ØµÙØ­Ø©" });
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬
  app.put("/api/products/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const productData = req.body;
      
      console.log("ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬:", id, productData);
      
      // ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„ØªØ®Ø²ÙŠÙ†
      const updatedProduct = await firebaseService.updateProduct(id, {
        name: productData.name,
        description: productData.description,
        price: productData.price,
        stock: productData.stock,
        sku: productData.sku,
        imageUrl: productData.imageUrl,
        categoryId: productData.categoryId ? parseInt(productData.categoryId) : undefined
      });

      if (updatedProduct) {
        console.log("ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­:", updatedProduct);
        res.json(updatedProduct);
      } else {
        res.status(404).json({ message: "Ø§Ù„Ù…Ù†ØªØ¬ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
    } catch (error) {
      console.error("Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬:", error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // Orders routes
  app.get("/api/orders", async (req, res) => {
    try {
      const orders = await firebaseService.getOrders();
      res.json(orders);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨Ø§Øª" });
    }
  });

  app.get("/api/orders/:id", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const order = await firebaseService.getOrder(id);
      
      if (!order) {
        return res.status(404).json({ message: "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      res.json(order);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø·Ù„Ø¨" });
    }
  });

  app.post("/api/orders", async (req, res) => {
    try {
      console.log('Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ù…Ø±Ø³Ù„Ø© Ù„Ù„Ø·Ù„Ø¨:', req.body);
      
      const { customerInfo, items, customerPrice, deliveryFee, totalWithDelivery, wholesaleTotal, profit, totalItems, orderDate } = req.body;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø£Ø³Ø§Ø³ÙŠØ©
      if (!customerInfo || !items || !totalWithDelivery) {
        return res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯ Ø¨ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø²Ø¨ÙˆÙ†
      const orderData = {
        customerId: null,
        total: totalWithDelivery.toString(),
        status: 'pending',
        customerDetails: {
          name: customerInfo.name,
          phone: customerInfo.phone,
          governorate: customerInfo.governorate,
          area: customerInfo.area,
          address: customerInfo.address,
          notes: customerInfo.notes
        },
        items: items,
        customerPrice: customerPrice || 0,
        deliveryFee: deliveryFee || 0,
        totalWithDelivery: totalWithDelivery,
        wholesaleTotal: wholesaleTotal || 0,
        profit: profit || 0,
        totalItems: totalItems || items.length,
        orderDate: orderDate || new Date().toISOString()
      };

      console.log('Ø­ÙØ¸ Ø·Ù„Ø¨ Ø¬Ø¯ÙŠØ¯:', orderData);
      
      const order = await firebaseService.createOrder(orderData);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­:', order);
      
      res.status(201).json({ 
        message: "ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø§Ù„Ø·Ù„Ø¨ Ø¨Ù†Ø¬Ø§Ø­", 
        order: order 
      });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ø·Ù„Ø¨:', error);
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  app.put("/api/orders/:id/status", async (req, res) => {
    try {
      const id = parseInt(req.params.id);
      const { status } = z.object({ status: z.string() }).parse(req.body);
      
      const order = await firebaseService.updateOrderStatus(id, status);
      
      if (!order) {
        return res.status(404).json({ message: "Ø§Ù„Ø·Ù„Ø¨ ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
      
      res.json(order);
    } catch (error) {
      res.status(400).json({ message: "Ø¨ÙŠØ§Ù†Ø§Øª ØºÙŠØ± ØµØ­ÙŠØ­Ø©" });
    }
  });

  // Analytics routes
  app.get("/api/stats", async (req, res) => {
    try {
      const stats = await firebaseService.getStats();
      res.json(stats);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø¥Ø­ØµØ§Ø¦ÙŠØ§Øª" });
    }
  });

  // Download analytics route
  app.post("/api/analytics/download", async (req, res) => {
    try {
      const { productId, productName, action, timestamp } = req.body;
      
      // Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„ØªØ­Ù…ÙŠÙ„ ÙÙŠ Firebase (ÙŠÙ…ÙƒÙ† Ø¥Ø¶Ø§ÙØ© ØªÙØ§ØµÙŠÙ„ Ø£ÙƒØ«Ø± Ù„Ø§Ø­Ù‚Ø§Ù‹)
      console.log('ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© ØªØ­Ù…ÙŠÙ„:', {
        productId,
        productName,
        action,
        timestamp
      });
      
      res.json({ message: "ØªÙ… ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„ Ø¨Ù†Ø¬Ø§Ø­" });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ³Ø¬ÙŠÙ„ Ø¹Ù…Ù„ÙŠØ© Ø§Ù„ØªØ­Ù…ÙŠÙ„" });
    }
  });

  // Saved products routes
  app.get("/api/saved-products", async (req, res) => {
    try {
      const savedProducts = await firebaseService.getSavedProducts();
      res.json(savedProducts);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø©" });
    }
  });

  app.post("/api/saved-products", async (req, res) => {
    try {
      const { productId } = req.body;
      console.log('Ø·Ù„Ø¨ Ø­ÙØ¸ Ù…Ù†ØªØ¬:', { productId });
      
      if (!productId) {
        return res.status(400).json({ message: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨" });
      }

      // Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ù„Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª
      const savedProduct = await firebaseService.addToSavedProducts(productId);
      console.log('ØªÙ… Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬ Ø¨Ù†Ø¬Ø§Ø­:', savedProduct);
      res.json(savedProduct);
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  app.delete("/api/saved-products/:productId", async (req, res) => {
    try {
      const productId = parseInt(req.params.productId);
      await firebaseService.removeFromSavedProducts(productId);
      res.json({ message: "ØªÙ… Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª" });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¥Ø²Ø§Ù„Ø© Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ù…Ø­ÙÙˆØ¸Ø§Øª" });
    }
  });

  // Cart routes - using Firebase
  app.get("/api/cart", async (req, res) => {
    try {
      // Ø¬Ù„Ø¨ Ø¹Ù†Ø§ØµØ± Ø§Ù„Ø³Ù„Ø© Ù…Ù† Firebase
      const cartItems = await firebaseService.getCartItems();
      res.json(cartItems);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¬Ù„Ø¨ Ø§Ù„Ø³Ù„Ø©" });
    }
  });

  app.post("/api/cart", async (req, res) => {
    try {
      const { productId, quantity = 1 } = req.body;
      
      if (!productId) {
        return res.status(400).json({ message: "Ù…Ø¹Ø±Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ø·Ù„ÙˆØ¨" });
      }

      // Ø¥Ø¶Ø§ÙØ© Ø£Ùˆ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ù…Ù†ØªØ¬ ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      const cartItem = await firebaseService.addToCart(productId, quantity);
      res.json(cartItem);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ù…Ù†ØªØ¬ Ø¥Ù„Ù‰ Ø§Ù„Ø³Ù„Ø©" });
    }
  });

  app.delete("/api/cart/:productId", async (req, res) => {
    try {
      const productId = parseInt(req.params.productId);
      await firebaseService.removeFromCart(productId);
      res.json({ message: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©" });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ù…Ù†ØªØ¬ Ù…Ù† Ø§Ù„Ø³Ù„Ø©" });
    }
  });

  // Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©
  app.delete("/api/cart", async (req, res) => {
    try {
      // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¹Ù†Ø§ØµØ± ÙÙŠ Ø§Ù„Ø³Ù„Ø©
      const cartItems = await firebaseService.getCartItems();
      
      // Ø­Ø°Ù ÙƒÙ„ Ù…Ù†ØªØ¬
      for (const item of cartItems) {
        await firebaseService.removeFromCart(item.productId);
      }
      
      res.json({ message: "ØªÙ… Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©" });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø¬Ù…ÙŠØ¹ Ø§Ù„Ù…Ù†ØªØ¬Ø§Øª Ù…Ù† Ø§Ù„Ø³Ù„Ø©" });
    }
  });

  app.put("/api/cart/:productId", async (req, res) => {
    try {
      const productId = parseInt(req.params.productId);
      const { quantity } = req.body;
      
      const cartItem = await firebaseService.updateCartQuantity(productId, quantity);
      res.json(cartItem);
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« ÙƒÙ…ÙŠØ© Ø§Ù„Ù…Ù†ØªØ¬" });
    }
  });

  // Save cart data with customer pricing
  app.post("/api/cart/save", async (req, res) => {
    try {
      const { customerPrice, discount, items } = req.body;
      
      const wholesaleTotal = items.reduce((total: number, item: any) => 
        total + (parseFloat(item.product.price) * item.quantity), 0);
      
      const profit = customerPrice - wholesaleTotal;
      const finalProfit = profit < 0 ? 0 : profit;
      
      const cartData = {
        items,
        customerPrice: customerPrice || 0,
        discount: discount || 0,
        wholesaleTotal,
        profit: finalProfit,
        totalPrice: customerPrice || 0,
        updatedAt: new Date().toISOString()
      };

      console.log('Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø©:', cartData);
      
      res.json({ 
        message: "ØªÙ… Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø© Ø¨Ù†Ø¬Ø§Ø­", 
        data: cartData 
      });
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø©:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­ÙØ¸ Ø¨ÙŠØ§Ù†Ø§Øª Ø§Ù„Ø³Ù„Ø©: " + error.message });
    }
  });

  // File upload endpoint for general use
  app.post("/api/upload", async (req, res) => {
    try {
      const mockUrl = "https://via.placeholder.com/300x300?text=Product+Image";
      res.json({ url: mockUrl });
    } catch (error) {
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„Ù…Ù„Ù" });
    }
  });

  // Image upload endpoint for banners
  app.post("/api/upload-image", upload.single('image'), async (req, res) => {
    try {
      if (!req.file) {
        return res.status(400).json({ message: "Ù„Ù… ÙŠØªÙ… Ø±ÙØ¹ Ø£ÙŠ ØµÙˆØ±Ø©" });
      }
      
      const imageUrl = `/uploads/${req.file.filename}`;
      res.json({ url: imageUrl });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø±ÙØ¹ Ø§Ù„ØµÙˆØ±Ø©" });
    }
  });

  // ==================== BANNERS ROUTES ====================
  
  // Ù…ØµÙÙˆÙØ© Ù„Ø­ÙØ¸ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ù…Ø¤Ù‚ØªØ§Ù‹ ÙÙŠ Ø§Ù„Ø°Ø§ÙƒØ±Ø©
  let tempBanners: any[] = [];

  // Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ù…Ù† Firebase (Ù„Ø¥Ø¹Ø§Ø¯Ø© Ø§Ù„Ø¨Ø¯Ø¡)
  app.delete("/api/banners/clear-all", async (req, res) => {
    try {
      // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ù…Ù† Firebase
      const existingBanners = await firebaseService.getBanners();
      for (const banner of existingBanners) {
        await firebaseService.deleteBanner(banner.id);
      }
      
      // Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©
      tempBanners = [];
      
      console.log('âœ… ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­');
      res.json({ message: "ØªÙ… Ù…Ø³Ø­ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø¨Ù†Ø¬Ø§Ø­" });
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ù…Ø³Ø­ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª" });
    }
  });
  
  // Ø¬Ù„Ø¨ Ø¬Ù…ÙŠØ¹ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª - Ù†Ø¸Ø§Ù… Ø¬Ø¯ÙŠØ¯
  app.get("/api/banners", async (req, res) => {
    try {
      // Ø¬Ù„Ø¨ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ù…Ù† Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª ÙÙ‚Ø· (Ø¨Ø¯Ø§ÙŠØ© Ø¬Ø¯ÙŠØ¯Ø©)
      console.log('Ø¥Ø±Ø¬Ø§Ø¹ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ø¬Ø¯ÙŠØ¯Ø©:', tempBanners.length);
      res.json(tempBanners);
    } catch (error) {
      console.log('Ø¥Ø±Ø¬Ø§Ø¹ Ù‚Ø§Ø¦Ù…Ø© ÙØ§Ø±ØºØ©');
      res.json([]);
    }
  });

  // Ø¥Ø¶Ø§ÙØ© Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯
  app.post("/api/banners", async (req, res) => {
    try {
      const { title, description, isActive, imageUrl } = req.body;
      
      // Ø§Ù„ØªØ­Ù‚Ù‚ Ù…Ù† ÙˆØ¬ÙˆØ¯ Ø§Ù„Ø¹Ù†ÙˆØ§Ù†
      if (!title || title.trim() === '') {
        return res.status(400).json({ message: "Ø¹Ù†ÙˆØ§Ù† Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ø·Ù„ÙˆØ¨" });
      }
      
      // Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯ Ù…Ø¤Ù‚Øª (Ø³ÙŠØªÙ… Ø±Ø¨Ø·Ù‡ Ø¨Ù€ Firebase Ù„Ø§Ø­Ù‚Ø§Ù‹)
      const bannerData = {
        id: Date.now().toString(),
        title: title.trim(),
        description: description ? description.trim() : '',
        isActive: isActive === 'true' || isActive === true || isActive,
        imageUrl: imageUrl || '',
        createdAt: new Date()
      };

      // Ø§Ù„Ø¢Ù† Ù†Ø­ÙØ¸ ÙÙŠ Firebase Ù…Ø¨Ø§Ø´Ø±Ø© Ù…Ø¹ Ù†Ø¸Ø§Ù… Ø¨Ø§Ù†Ø±Ø§Øª Ø¬Ø¯ÙŠØ¯
      try {
        const firebaseBanner = await firebaseService.createBanner(bannerData);
        console.log('âœ… ØªÙ… Ø¥Ù†Ø´Ø§Ø¡ Ø¨Ø§Ù†Ø± Ø¬Ø¯ÙŠØ¯ ÙÙŠ Firebase:', firebaseBanner);
        res.status(201).json(firebaseBanner);
      } catch (firebaseError) {
        console.log('âš ï¸ ÙØ´Ù„ ÙÙŠ FirebaseØŒ Ø­ÙØ¸ Ù…Ø¤Ù‚Øª:', firebaseError);
        tempBanners.push(bannerData);
        console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ù…Ø¤Ù‚ØªØ©:', tempBanners.length);
        res.status(201).json(bannerData);
      }
    } catch (error: any) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù†Ø±:', error);
      res.status(500).json({ 
        message: "Ø¹Ø°Ø±Ø§Ù‹ØŒ Ø­Ø¯Ø« Ø®Ø·Ø£ Ø£Ø«Ù†Ø§Ø¡ Ø¥Ø¶Ø§ÙØ© Ø§Ù„Ø¨Ø§Ù†Ø±. ÙŠØ±Ø¬Ù‰ Ø§Ù„Ù…Ø­Ø§ÙˆÙ„Ø© Ù…Ø±Ø© Ø£Ø®Ø±Ù‰",
        error: process.env.NODE_ENV === 'development' ? error.message : undefined
      });
    }
  });

  // ØªØ­Ø¯ÙŠØ« Ø¨Ø§Ù†Ø±
  app.put("/api/banners/:id", upload.single('image'), async (req, res) => {
    try {
      const id = req.params.id; // Ø§Ø³ØªØ®Ø¯Ø§Ù… string ID Ù…Ø¨Ø§Ø´Ø±Ø©
      const { title, description, isActive } = req.body;

      const updateData: any = {
        title,
        description: description || null,
        isActive: isActive === 'true' || isActive === true,
      };

      if (req.file) {
        updateData.imageUrl = `/uploads/${req.file.filename}`;
      }

      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù†Ø± ÙÙŠ Firebase Ø£ÙˆÙ„Ø§Ù‹
        const updatedBanner = await firebaseService.updateBanner(id, updateData);
        console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù†Ø± ÙÙŠ Firebase:', updatedBanner);
        res.status(200).json(updatedBanner);
      } catch (firebaseError) {
        // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ FirebaseØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
        const bannerIndex = tempBanners.findIndex(b => b.id === req.params.id);
        if (bannerIndex !== -1) {
          tempBanners[bannerIndex] = {
            ...tempBanners[bannerIndex],
            title: updateData.title,
            description: updateData.description || '',
            imageUrl: updateData.imageUrl || tempBanners[bannerIndex].imageUrl,
            isActive: updateData.isActive,
            updatedAt: new Date()
          };
          
          console.log('âœ… ØªÙ… ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ø¤Ù‚ØªØ§Ù‹:', tempBanners[bannerIndex]);
          res.status(200).json(tempBanners[bannerIndex]);
        } else {
          res.status(404).json({ message: "Ø§Ù„Ø¨Ø§Ù†Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
        }
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù†Ø±:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØ­Ø¯ÙŠØ« Ø§Ù„Ø¨Ø§Ù†Ø±" });
    }
  });

  // ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ù†Ø± (Ù†Ø´Ø·/ØºÙŠØ± Ù†Ø´Ø·)
  app.put("/api/banners/:id/toggle", async (req, res) => {
    try {
      const id = req.params.id;
      const { isActive } = req.body;

      // Ø§Ù„Ø¨Ø­Ø« Ø¹Ù† Ø§Ù„Ø¨Ø§Ù†Ø± ÙÙŠ Ø§Ù„Ù…ØµÙÙˆÙØ© Ø§Ù„Ù…Ø¤Ù‚ØªØ© ÙˆØªØ­Ø¯ÙŠØ« Ø­Ø§Ù„ØªÙ‡
      const bannerIndex = tempBanners.findIndex(b => b.id === id);
      if (bannerIndex !== -1) {
        tempBanners[bannerIndex].isActive = isActive;
        tempBanners[bannerIndex].updatedAt = new Date();
        
        console.log('ØªÙ… ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­:', tempBanners[bannerIndex]);
        res.json(tempBanners[bannerIndex]);
      } else {
        res.status(404).json({ message: "Ø§Ù„Ø¨Ø§Ù†Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ù†Ø±:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ ØªØºÙŠÙŠØ± Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ø§Ù†Ø±" });
    }
  });

  // Ø­Ø°Ù Ø¨Ø§Ù†Ø±
  app.delete("/api/banners/:id", async (req, res) => {
    try {
      const id = req.params.id;
      
      try {
        // Ù…Ø­Ø§ÙˆÙ„Ø© Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ù† Firebase Ø£ÙˆÙ„Ø§Ù‹
        const deleted = await firebaseService.deleteBanner(id);
        if (deleted) {
          console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ù† Firebase Ø¨Ù†Ø¬Ø§Ø­');
          res.json({ message: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­" });
        } else {
          res.status(404).json({ message: "Ø§Ù„Ø¨Ø§Ù†Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
        }
      } catch (firebaseError) {
        // ÙÙŠ Ø­Ø§Ù„Ø© ÙØ´Ù„ FirebaseØŒ Ø§Ù„Ø¨Ø­Ø« ÙÙŠ Ø§Ù„Ù…Ø®Ø²Ù† Ø§Ù„Ù…Ø¤Ù‚Øª
        const bannerIndex = tempBanners.findIndex(b => b.id === id);
        if (bannerIndex !== -1) {
          const deletedBanner = tempBanners.splice(bannerIndex, 1)[0];
          console.log('ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ù…Ø¤Ù‚ØªØ§Ù‹:', deletedBanner.title);
          console.log('Ø¹Ø¯Ø¯ Ø§Ù„Ø¨Ø§Ù†Ø±Ø§Øª Ø§Ù„Ù…ØªØ¨Ù‚ÙŠØ©:', tempBanners.length);
          res.json({ message: "ØªÙ… Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø± Ø¨Ù†Ø¬Ø§Ø­" });
        } else {
          res.status(404).json({ message: "Ø§Ù„Ø¨Ø§Ù†Ø± ØºÙŠØ± Ù…ÙˆØ¬ÙˆØ¯" });
        }
      }
    } catch (error) {
      console.error('Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø±:', error);
      res.status(500).json({ message: "Ø®Ø·Ø£ ÙÙŠ Ø­Ø°Ù Ø§Ù„Ø¨Ø§Ù†Ø±" });
    }
  });

  const httpServer = createServer(app);
  return httpServer;
}
